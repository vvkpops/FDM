<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FlyHigh‚Ñ¢ Dispatch</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">
<div class="max-w-7xl mx-auto p-6">
  <header class="relative p-4 bg-gray-800 shadow-md text-center text-xl font-bold mb-6">
    <div id="clock-local" class="absolute left-4 top-1/2 -translate-y-1/2 text-lg font-mono text-gray-300"></div>
    FlyHigh‚Ñ¢ Dispatch
    <div id="clock-utc" class="absolute right-4 top-1/2 -translate-y-1/2 text-lg font-mono text-gray-300"></div>
  </header>

  <div class="flex flex-wrap justify-center items-center gap-4 mb-6">
    <label>Ceiling (ft):
      <input id="globalCeiling" type="number" class="bg-gray-700 p-1 rounded w-24 text-center" />
    </label>
    <label>Visibility (SM):
      <input id="globalVis" type="number" step="0.1" class="bg-gray-700 p-1 rounded w-24 text-center" />
    </label>
    <button onclick="applyGlobalMinima()" class="bg-green-600 px-3 py-1 rounded text-white hover:bg-green-700 text-sm">Apply to All</button>
  </div>

  <div class="flex flex-wrap justify-center items-center gap-4 mb-6">
    <label>Flights:
      <input id="flightFilter" placeholder="ACA111, PVL222" class="bg-gray-700 p-1 rounded w-64 text-center" />
    </label>
    <button onclick="applyFilter()" class="bg-blue-600 px-3 py-1 rounded text-white hover:bg-blue-700 text-sm">Filter Flights</button>
    <button onclick="clearFilter()" class="bg-gray-600 px-3 py-1 rounded text-white hover:bg-gray-700 text-sm">Clear Filter</button>
  </div>

  <div class="p-6">
    <details open>
      <summary class="text-lg font-bold cursor-pointer mb-2">‚úÖ Completed Flights (last 10)</summary>
      <div id="completedFlights" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-2"></div>
    </details>

    <details open>
      <summary class="text-lg font-bold cursor-pointer mb-2 mt-6">‚úàÔ∏è Enroute & Scheduled Flights (12hr window)</summary>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="activeFlights"></div>
    </details>
  </div>

  <footer class="text-sm text-center text-gray-500 py-4">
    Live from Google Sheets | Updated <span id="lastUpdated">‚Äî</span>
  </footer>
</div>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrYY4e86FUw6GFaHj1I_VI2JRmKgkLepqs2uJ4myjzRUYUz3TNpOsNSJvxZELbdwN2Pe_fTdEfNyWE/pub?gid=549523756&single=true&output=csv";
const minima = {}, flights = [], toggleAlt = {};
const corsProxy = "https://corsproxy.io/?";
let filterList = [];

async function loadFlights() {
    const res = await fetch(csvUrl);
    const txt = await res.text();
    const [header, ...lines] = txt.trim().split("\n");
    const keys = header.split(",").map(k=>k.trim().toLowerCase());
    lines.forEach(line => {
        const values = line.split(",");
        const obj = {};
        keys.forEach((k,i) => obj[k] = values[i]?.trim());
        flights.push({
          callsign: obj.callsign,
          depicao: obj.departureicao,
          alticao: obj.alternateicao,
          std: obj.departuretime.endsWith("Z") ? obj.departuretime : obj.departuretime+"Z",
          sta: obj.arrivaltime.endsWith("Z") ? obj.arrivaltime : obj.arrivaltime+"Z",
          eta: obj.eta.endsWith("Z") ? obj.eta : obj.eta+"Z",
          arricao: obj.arrivalicao
        });
    });
}

async function fetchTAF(icao) {
    const res = await fetch(`${corsProxy}https://aviationweather.gov/cgi-bin/data/taf.php?ids=${icao}&format=raw`);
    return (await res.text()).trim();
}
async function fetchMETAR(icao) {
    const res = await fetch(`${corsProxy}https://aviationweather.gov/cgi-bin/data/metar.php?ids=${icao}&format=raw`);
    return (await res.text()).trim();
}

function shortTime(s) {
    const d = new Date(s);
    return d.toISOString().slice(11,16) + "Z";
}
function calculateProgress(std, eta) {
    const now = new Date(), start = new Date(std), end = new Date(eta);
    if (now < start) return 0;
    if (now > end) return 100;
    return ((now - start) / (end - start) * 100).toFixed(1);
}

function applyGlobalMinima() {
    const ceil = parseFloat(document.getElementById("globalCeiling").value);
    const vis = parseFloat(document.getElementById("globalVis").value);
    Object.keys(minima).forEach(c => minima[c] = { ceiling: ceil, vis: vis });
    buildDashboard();
}
function applyFilter() {
    filterList = document.getElementById("flightFilter").value.split(",").map(s=>s.trim().toUpperCase()).filter(Boolean);
    buildDashboard();
}
function clearFilter() {
    filterList = [];
    document.getElementById("flightFilter").value = "";
    buildDashboard();
}

function parseLine(line) {
    let ceiling=Infinity, visMiles=Infinity, isGreater=false;
    const cloud = line.match(/(BKN|OVC|VV)(\d{3})/);
    if (cloud) ceiling = parseInt(cloud[2]) * 100;
    const vis = line.match(/(P?\d{1,2})SM/);
    if (vis) {
        if (vis[1].startsWith("P")) { visMiles = parseInt(vis[1].slice(1)); isGreater=true; }
        else visMiles = parseInt(vis[1]);
    }
    return { ceiling, visMiles, isGreater };
}
function highlightTAF(raw, minC, minV) {
    let below = false;
    const html = raw.split("\n").map(line=>{
        const p = parseLine(line);
        const visOk = p.isGreater ? true : (p.visMiles >= minV);
        const ceilOk = p.ceiling >= minC;
        if (!(visOk && ceilOk)) below = true;
        return `<div class="${!(visOk&&ceilOk)?"text-red-400":""}">${line}</div>`;
    }).join("");
    return { html, below };
}

async function updateTile(flight, container) {
    const useAlt = toggleAlt[flight.callsign];
    const icao = useAlt ? flight.alticao : flight.arricao;
    let tafRaw="", metarRaw="", taf={html:"",below:false};
    if (icao) {
        [tafRaw, metarRaw] = await Promise.all([fetchTAF(icao), fetchMETAR(icao)]);
        taf = highlightTAF(tafRaw, minima[flight.callsign].ceiling, minima[flight.callsign].vis);
    }
    const status = taf.html ? (taf.below ? `<span class="text-red-400 font-bold">üö® Below minima</span>` 
                                         : `<span class="text-green-400 font-bold">‚úÖ Above minima</span>`) : "";
    container.innerHTML = `
      <div class="text-2xl font-bold text-center">${flight.callsign}</div>
      <div class="text-sm text-center mb-2">Destination: ${flight.arricao} | Alternate: ${flight.alticao}</div>
      <div class="text-lg flex justify-around mt-2 mb-2">
        <div>STD: ${shortTime(flight.std)}</div>
        <div>STA: ${shortTime(flight.sta)}</div>
        <div>ETA: ${shortTime(flight.eta)}</div>
      </div>
      <div class="w-full bg-gray-700 rounded h-2 mt-1">
        <div class="bg-green-500 h-2 rounded" style="width:${calculateProgress(flight.std, flight.eta)}%"></div>
      </div>
      <div class="flex justify-between text-sm mt-1 font-bold">
        <div>${flight.depicao} (STD)</div>
        <div>${useAlt?flight.alticao:flight.arricao} (${useAlt?"ALT":"ETA"})</div>
      </div>
      <div class="flex gap-3 items-center mt-2 text-xs">
        <label>Ceil: <input type="number" value="${minima[flight.callsign].ceiling}"
          class="bg-gray-700 p-1 rounded w-20 text-center"
          onchange="minima['${flight.callsign}'].ceiling=this.value; updateTile(${JSON.stringify(flight).replace(/"/g,'&quot;')}, this.parentNode.parentNode.parentNode)"/></label>
        <label>Vis: <input type="number" step="0.1" value="${minima[flight.callsign].vis}"
          class="bg-gray-700 p-1 rounded w-20 text-center"
          onchange="minima['${flight.callsign}'].vis=this.value; updateTile(${JSON.stringify(flight).replace(/"/g,'&quot;')}, this.parentNode.parentNode.parentNode)"/></label>
      </div>
      <div class="mt-2 text-xs font-bold">
        TAF (${useAlt?"Alternate":"Destination"}): 
        <button onclick="toggleAlt['${flight.callsign}']=!toggleAlt['${flight.callsign}']; updateTile(${JSON.stringify(flight).replace(/"/g,'&quot;')}, this.parentNode.parentNode)"
          class="ml-2 bg-blue-600 px-2 py-0.5 rounded text-white text-xs">
          ${useAlt?"Show Destination":"Show Alternate"}
        </button>
      </div>
      ${metarRaw ? `<div class="mt-2 text-xs"><strong>METAR:</strong> ${metarRaw}</div>` : ""}
      ${taf.html ? `<div class="mt-2 text-xs"><strong>TAF:</strong><br>${taf.html}</div>` : ""}
      <div class="mt-2 text-sm">${status}</div>
    `;
}

async function buildDashboard() {
    const now=new Date(), completed=[], enroute=[], scheduled=[];
    flights.forEach(f=>{
        minima[f.callsign]=minima[f.callsign]||{ceiling:500,vis:1};
        toggleAlt[f.callsign]=toggleAlt[f.callsign]||false;
        const start=new Date(f.std), end=new Date(f.eta);
        if(now>end) completed.push(f);
        else if(start<=now && now<=end) enroute.push(f);
        else if(start>now && (start-now)<=12*3600000) scheduled.push(f);
    });
    completed.sort((a,b)=>new Date(b.eta)-new Date(a.eta));
    enroute.sort((a,b)=>new Date(a.eta)-new Date(b.eta));
    scheduled.sort((a,b)=>new Date(a.std)-new Date(b.std));
    const activeContainer=document.getElementById("activeFlights");
    const completedContainer=document.getElementById("completedFlights");
    activeContainer.innerHTML=completedContainer.innerHTML="";
    completed.slice(0,10).forEach(f=>{
        if(filterList.length && !filterList.includes(f.callsign)) return;
        const div=document.createElement("div");
        div.className="bg-gray-800 rounded-lg shadow p-3 border border-gray-700 hover:scale-105 transition-transform duration-300";
        div.innerHTML=`<div class="text-xl font-bold text-center mb-1">${f.callsign}</div>
          <div class="flex justify-around text-sm mb-1"><div>STD: ${shortTime(f.std)}</div>
          <div>STA: ${shortTime(f.sta)}</div><div>ETA: ${shortTime(f.eta)}</div></div>
          <div class="w-full bg-gray-700 rounded h-1 mt-1"><div class="bg-green-500 h-1 rounded w-full"></div></div>
          <div class="flex justify-between text-xs mt-1 font-bold">
          <div>${f.depicao} (STD)</div><div>${f.arricao} (ETA)</div></div>
          <div class="text-xs mt-1 font-bold">Alternate: ${f.alticao}</div>`;
        completedContainer.appendChild(div);
    });
    [...enroute,...scheduled].forEach(f=>{
        if(filterList.length && !filterList.includes(f.callsign)) return;
        const div=document.createElement("div");
        div.className="bg-gray-800 rounded-xl shadow-md p-4 border border-gray-700 hover:scale-105 transition-transform duration-300";
        activeContainer.appendChild(div);
        updateTile(f, div);
    });
    document.getElementById("lastUpdated").textContent=new Date().toUTCString().slice(17,25);
}
setInterval(()=>{
    flights.length=0;
    loadFlights().then(buildDashboard);
},60000);
setInterval(()=>{
    const now=new Date();
    document.getElementById("clock-local").textContent=now.toLocaleTimeString()+" Local";
    document.getElementById("clock-utc").textContent=now.toUTCString().slice(17,25)+" UTC";
},1000);
loadFlights().then(buildDashboard);
</script>
</body>
</html>
