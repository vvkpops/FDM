<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FlyHigh™ Dispatch</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media (min-width: 1536px) {
      .flight-tile {
        font-size: 0.9rem;
        padding: 0.75rem;
      }
      .flight-title {
        font-size: 1.25rem;
      }
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

<header class="relative p-4 bg-gray-800 shadow-md text-center text-xl font-bold mb-6 max-w-screen-2xl mx-auto">
  <div id="clock-local" class="absolute left-4 top-1/2 -translate-y-1/2 text-lg font-mono text-gray-300"></div>
  FlyHigh™ Dispatch
  <div id="clock-utc" class="absolute right-4 top-1/2 -translate-y-1/2 text-lg font-mono text-gray-300"></div>
</header>

<!-- NAVIGATION -->
<div class="flex justify-center gap-4 mb-4">
  <button onclick="showPage('flights')" class="bg-blue-600 px-4 py-2 rounded text-white hover:bg-blue-700">Flights Dashboard</button>
  <button onclick="showPage('weather')" class="bg-teal-600 px-4 py-2 rounded text-white hover:bg-teal-700">Weather Monitor</button>
</div>

<!-- GLOBAL FILTERS -->
<div class="max-w-screen-2xl mx-auto px-6 mb-4">
  <div class="flex flex-wrap justify-center items-center gap-4 mb-4">
    <label>Ceiling (ft):
      <input id="globalCeiling" type="number" class="bg-gray-700 p-1 rounded w-24 text-center" />
    </label>
    <label>Visibility (SM):
      <input id="globalVis" type="number" step="0.1" class="bg-gray-700 p-1 rounded w-24 text-center" />
    </label>
    <button onclick="applyGlobalMinima()" class="bg-green-600 px-3 py-1 rounded text-white hover:bg-green-700 text-sm">Apply to All</button>
    <button id="toggleWeatherBtn"
      onclick="toggleWeatherView()"
      class="bg-yellow-600 px-3 py-1 rounded text-white hover:bg-yellow-700 text-sm">
      Minimize Weather
    </button>
  </div>
</div>

<!-- FLIGHTS PAGE -->
<div id="flightsPage" class="w-full px-6">
  <details open>
    <summary class="text-lg font-bold cursor-pointer mb-2">✅ Completed Flights (last 10)</summary>
    <div id="completedFlights" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4 mt-2"></div>
  </details>

  <details open>
    <summary class="text-lg font-bold cursor-pointer mb-2 mt-6">✈️ Enroute & Scheduled Flights (12hr window)</summary>
    <div id="activeFlights" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>
  </details>
</div>

<!-- WEATHER PAGE -->
<div id="weatherPage" class="w-full px-6 hidden">
  <div class="flex justify-center gap-2 mb-4">
    <input id="icaoInput" placeholder="Enter ICAO (e.g. CYYT)" class="bg-gray-700 p-2 rounded text-center w-40" />
    <button onclick="addWeatherICAO()" class="bg-blue-600 px-3 py-1 rounded text-white hover:bg-blue-700">Add ICAO</button>
  </div>
  <div id="weatherTiles" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6"></div>
</div>

<footer class="text-sm text-center text-gray-500 py-4 max-w-screen-2xl mx-auto">
  Live from Google Sheets | Updated <span id="lastUpdated">—</span>
</footer>

<script>
const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRrYY4e86FUw6GFaHj1I_VI2JRmKgkLepqs2uJ4myjzRUYUz3TNpOsNSJvxZELbdwN2Pe_fTdEfNyWE/pub?gid=549523756&single=true&output=csv";
const corsProxy = "https://corsproxy.io/?";
const weatherCache = {};
const TAF_CACHE_MS = 600000;
const METAR_CACHE_MS = 60000;
const minima = {}, flights = [], toggleAlt = {};
let showWeather = true;
let weatherICAOs = JSON.parse(localStorage.getItem("weatherICAOs") || "[]");

// Load flights from Google Sheets
async function loadFlights() {
  const res = await fetch(csvUrl + "&" + Date.now());
  const txt = await res.text();
  const [header, ...lines] = txt.trim().split("\n");
  const keys = header.split(",").map(k => k.trim().toLowerCase());
  flights.length = 0;
  lines.forEach(line => {
    const values = line.split(",");
    const obj = {};
    keys.forEach((k, i) => obj[k] = values[i]?.trim());
    flights.push({
      callsign: obj.callsign,
      depicao: obj.departureicao,
      alticao: obj.alternateicao,
      std: obj.departuretime.endsWith("Z") ? obj.departuretime : obj.departuretime + "Z",
      sta: obj.arrivaltime.endsWith("Z") ? obj.arrivaltime : obj.arrivaltime + "Z",
      eta: obj.eta.endsWith("Z") ? obj.eta : obj.eta + "Z",
      arricao: obj.arrivalicao
    });
  });
}

async function fetchTAF(icao) {
  if (!icao) return "";
  const cached = weatherCache[icao]?.taf;
  if (cached && (Date.now() - cached.time < TAF_CACHE_MS)) return cached.data;
  const res = await fetch(`${corsProxy}https://aviationweather.gov/cgi-bin/data/taf.php?ids=${icao}&format=raw`);
  const text = (await res.text()).trim();
  weatherCache[icao] = weatherCache[icao] || {};
  weatherCache[icao].taf = { data: text, time: Date.now() };
  return text;
}

async function fetchMETAR(icao) {
  if (!icao) return "";
  const cached = weatherCache[icao]?.metar;
  if (cached && (Date.now() - cached.time < METAR_CACHE_MS)) return cached.data;
  const res = await fetch(`${corsProxy}https://aviationweather.gov/cgi-bin/data/metar.php?ids=${icao}&format=raw`);
  const text = (await res.text()).trim();
  weatherCache[icao] = weatherCache[icao] || {};
  weatherCache[icao].metar = { data: text, time: Date.now() };
  return text;
}

function shortTime(s) {
  const d = new Date(s);
  return d.toISOString().slice(11, 16) + "Z";
}

function calculateProgress(std, eta) {
  const now = new Date(), start = new Date(std), end = new Date(eta);
  if (now < start) return 0;
  if (now > end) return 100;
  return ((now - start) / (end - start) * 100).toFixed(1);
}

function applyGlobalMinima() {
  const ceil = parseFloat(document.getElementById("globalCeiling").value);
  const vis = parseFloat(document.getElementById("globalVis").value);
  Object.keys(minima).forEach(c => minima[c] = { ceiling: ceil, vis: vis });
  buildDashboard();
  buildWeatherTiles();
}

function toggleWeatherView() {
  showWeather = !showWeather;
  document.getElementById("toggleWeatherBtn").textContent = showWeather ? "Minimize Weather" : "Show Weather";
  buildDashboard();
  buildWeatherTiles();
}

function parseLine(line) {
  let ceiling = Infinity, visMiles = Infinity, isGreater = false;
  const cloud = line.match(/(BKN|OVC|VV)(\d{3})/);
  if (cloud) ceiling = parseInt(cloud[2]) * 100;
  const vis = line.match(/(P?\d{1,2})SM/);
  if (vis) {
    if (vis[1].startsWith("P")) { visMiles = parseInt(vis[1].slice(1)); isGreater = true; }
    else visMiles = parseInt(vis[1]);
  }
  return { ceiling, visMiles, isGreater };
}

function highlightTAF(raw, minC, minV) {
  let below = false;
  const html = raw.split("\n").map(line => {
    const p = parseLine(line);
    const visOk = p.isGreater ? true : (p.visMiles >= minV);
    const ceilOk = p.ceiling >= minC;
    if (!(visOk && ceilOk)) below = true;
    return `<div class="${!(visOk && ceilOk) ? "text-red-400" : ""}">${line}</div>`;
  }).join("");
  return { html, below };
}

function showPage(page) {
  document.getElementById("flightsPage").classList.toggle("hidden", page !== "flights");
  document.getElementById("weatherPage").classList.toggle("hidden", page !== "weather");
}

async function updateWeatherTile(icao, container) {
  minima[icao] = minima[icao] || { ceiling: 500, vis: 1 };
  const [tafRaw, metarRaw] = await Promise.all([fetchTAF(icao), fetchMETAR(icao)]);
  const taf = highlightTAF(tafRaw, minima[icao].ceiling, minima[icao].vis);

  container.innerHTML = `
    <div class="flight-title text-2xl font-bold text-center">${icao}</div>
    ${showWeather ? `
      <div class="flex gap-3 items-center mt-2 text-xs">
        <label>Ceil: <input type="number" value="${minima[icao].ceiling}"
          class="bg-gray-700 p-1 rounded w-20 text-center"
          onchange="minima['${icao}'].ceiling=this.value; buildWeatherTiles()"/></label>
        <label>Vis: <input type="number" step="0.1" value="${minima[icao].vis}"
          class="bg-gray-700 p-1 rounded w-20 text-center"
          onchange="minima['${icao}'].vis=this.value; buildWeatherTiles()"/></label>
      </div>
      ${metarRaw ? `<div class="mt-2 text-xs"><strong>METAR:</strong> ${metarRaw}</div>` : ""}
      ${taf.html ? `<div class="mt-2 text-xs"><strong>TAF:</strong><br>${taf.html}</div>` : ""}
    ` : ""}
    <div class="flex justify-end mt-2">
      <button onclick="removeWeatherICAO('${icao}')" class="bg-red-600 px-2 py-1 text-xs rounded text-white hover:bg-red-700">Remove</button>
    </div>
  `;

  container.classList.remove("border-gray-700", "border-red-500", "border-green-500");
  if (taf.html) {
    container.classList.add(taf.below ? "border-red-500" : "border-green-500");
  } else {
    container.classList.add("border-gray-700");
  }
}

function addWeatherICAO() {
  const icaoInput = document.getElementById("icaoInput");
  const icao = icaoInput.value.trim().toUpperCase();
  if (icao && !weatherICAOs.includes(icao)) {
    weatherICAOs.push(icao);
    localStorage.setItem("weatherICAOs", JSON.stringify(weatherICAOs));
    buildWeatherTiles();
  }
  icaoInput.value = "";
  icaoInput.focus();
}

document.getElementById("icaoInput").addEventListener("keypress", function (e) {
  if (e.key === "Enter") {
    addWeatherICAO();
  }
});

function removeWeatherICAO(icao) {
  weatherICAOs = weatherICAOs.filter(i => i !== icao);
  localStorage.setItem("weatherICAOs", JSON.stringify(weatherICAOs));
  buildWeatherTiles();
}

function buildWeatherTiles() {
  const container = document.getElementById("weatherTiles");
  container.innerHTML = "";
  weatherICAOs.forEach(icao => {
    const div = document.createElement("div");
    div.className = "flight-tile bg-gray-800 rounded-xl shadow-md p-4 border border-gray-700";
    container.appendChild(div);
    updateWeatherTile(icao, div);
  });
}

async function buildDashboard() {
  const now=new Date(), completed=[], enroute=[], scheduled=[];
  flights.forEach(f=>{
    minima[f.callsign]=minima[f.callsign]||{ceiling:500,vis:1};
    toggleAlt[f.callsign]=toggleAlt[f.callsign]!==undefined?toggleAlt[f.callsign]:false;
    const start=new Date(f.std), end=new Date(f.eta);
    if(now>end) completed.push(f);
    else if(start<=now && now<=end) enroute.push(f);
    else if(start>now && (start-now)<=12*3600000) scheduled.push(f);
  });
  completed.sort((a,b)=>new Date(b.eta)-new Date(a.eta));
  enroute.sort((a,b)=>new Date(a.eta)-new Date(b.eta));
  scheduled.sort((a,b)=>new Date(a.std)-new Date(b.std));
  const activeContainer=document.getElementById("activeFlights");
  const completedContainer=document.getElementById("completedFlights");
  activeContainer.innerHTML=completedContainer.innerHTML="";
  completed.slice(0,10).forEach(f=>{
    const div=document.createElement("div");
    div.className="flight-tile bg-gray-800 rounded-lg shadow p-3 border border-gray-700";
    div.innerHTML=`<div class="text-xl font-bold text-center mb-1">${f.callsign}</div>
      <div class="flex justify-around text-sm mb-1"><div>STD: ${shortTime(f.std)}</div>
      <div>STA: ${shortTime(f.sta)}</div><div>ETA: ${shortTime(f.eta)}</div></div>
      <div class="w-full bg-gray-700 rounded h-1 mt-1"><div class="bg-green-500 h-1 rounded w-full"></div></div>
      <div class="flex justify-between text-xs mt-1 font-bold">
      <div>${f.depicao} (STD)</div><div>${f.arricao} (ETA)</div></div>
      <div class="text-xs mt-1 font-bold">Alternate: ${f.alticao}</div>`;
    completedContainer.appendChild(div);
  });
  [...enroute,...scheduled].forEach(f=>{
    const div=document.createElement("div");
    div.className="flight-tile bg-gray-800 rounded-xl shadow-md p-4 border border-gray-700 hover:scale-105 transition-transform duration-300";
    activeContainer.appendChild(div);
    updateTile(f, div);
  });
  document.getElementById("lastUpdated").textContent=new Date().toUTCString().slice(17,25);
}

async function updateTile(flight, container) {
  const useAlt = toggleAlt[flight.callsign];
  const icao = useAlt ? flight.alticao : flight.arricao;
  let tafRaw="", metarRaw="", taf={html:"",below:false};
  if (icao) {
    [tafRaw, metarRaw] = await Promise.all([fetchTAF(icao), fetchMETAR(icao)]);
    taf = highlightTAF(tafRaw, minima[flight.callsign].ceiling, minima[flight.callsign].vis);
  }
  const status = taf.html
    ? (taf.below 
        ? `<span class="text-red-400 font-bold">🚨 Below minima</span>`
        : `<span class="text-green-400 font-bold">✅ Above minima</span>`)
    : "";

  container.innerHTML = `
    <div class="flight-title text-2xl font-bold text-center">${flight.callsign}</div>
    <div class="text-sm text-center mb-2">
      Destination: ${flight.arricao} | Alternate: ${flight.alticao}
      <span class="block text-xs text-yellow-400">${useAlt ? '(Using Alternate)' : '(Using Destination)'}</span>
    </div>
    <div class="text-lg flex justify-around mt-2 mb-2">
      <div>STD: ${shortTime(flight.std)}</div>
      <div>STA: ${shortTime(flight.sta)}</div>
      <div>ETA: ${shortTime(flight.eta)}</div>
    </div>
    <div class="w-full bg-gray-700 rounded h-2 mt-1">
      <div class="bg-green-500 h-2 rounded" style="width:${calculateProgress(flight.std, flight.eta)}%"></div>
    </div>
    <div class="flex justify-between text-sm mt-1 font-bold">
      <div>${flight.depicao} (STD)</div>
      <div>${flight.arricao} (ETA)</div>
    </div>
    <div class="flex justify-center mt-2">
      <button 
        onclick="toggleAlt['${flight.callsign}']=!toggleAlt['${flight.callsign}']; updateTile(${JSON.stringify(flight).replace(/"/g,'&quot;')}, this.closest('.flight-tile'))"
        class="bg-purple-600 px-2 py-1 text-xs rounded text-white hover:bg-purple-700">
        Toggle Alternate
      </button>
    </div>
    ${showWeather ? `
    <div class="flex gap-3 items-center mt-2 text-xs">
      <label>Ceil: <input type="number" value="${minima[flight.callsign].ceiling}"
        class
